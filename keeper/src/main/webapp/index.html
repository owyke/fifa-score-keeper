<!DOCTYPE html>
<html lang="en">
<head>
    <title> Fifa Score Keeper </title>
    <script type="text/javascript" src="js/knockout-2.1.0.js"></script>
    <script type="text/javascript" src="js/model.js"></script>
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen"/>
    <!--<link href="css/main.css" rel="stylesheet" media="screen" />-->
    <link rel="stylesheet/less" type="text/css" href="css/less/main.less"/>
    <script src="js/less-1.3.1.min.js"></script>
</head>
<body>
<div id="main-wrapper" class="pagination-centered">
    <div id="inner-wrapper" class="box">
        <div class="row-fluid large-padding"></div>
        <div id="main-header" class="row-fluid"><h1>Fifa score</h1></div>
        <div class="row-fluid small-padding"></div>

        <section data-bind="visible: !$root.activeSession">
            <div class="row-fluid">
                <button data-bind="click: $root.showGameSessionModal" class="btn">Start game session</button>
            </div>
        </section>

        <section data-bind="visible: $root.activeSession">
            <div class="row-fluid" data-bind="with: $root.activeSession">
                Session name: <span data-bind="value: name"></span>
                Session location: <span data-bind="value: location"></span>
            </div>
        </section>


        <div class="row-fluid small-padding"></div>



        <section data-bind="with: setup">

            <div class="row-fluid">
                <input id="homeTeam" type="text" data-bind="value: homeTeam, typeahead: $parent.availableTeams" class="input-small homeBackground" placeholder="Home team"/>
                <input id="awayTeam" type="text" data-bind="value: awayTeam, typeahead: $parent.availableTeams" class="input-small awayBackground" placeholder="Away team"/>
            </div>
            <div class="row-fluid">
                <input id="homePlayer" type="text" data-bind="value: homePlayer, typeahead: $parent.availablePlayers" class="input-small homeBackground" placeholder="Player home"/>
                <input id="awayPlayer" type="text" data-bind="value: awayPlayer, typeahead: $parent.availablePlayers" class="input-small awayBackground" placeholder="Player away"/>
            </div>
            <div class="row-fluid">
                <button data-bind="enable: $parent.setupComplete(), click: $parent.showScoreModal" class="btn">Register match result</button>
            </div>

        </section>
        <div id="resultModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
                <h3 id="myModalLabel">Enter score</h3>
            </div>
            <div class="modal-body">
                <input id="homeGoals" type="text" data-bind="value: homeGoals" class="input-small homeBackground" placeholder="Home goals"/>
                <input id="awayGoals" type="text" data-bind="value: awayGoals" class="input-small awayBackground" placeholder="Away goals"/>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
                <button class="btn btn-primary" data-bind="click: $root.registerScore">Register</button>
            </div>
        </div>


        <div id="sessionModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
                <h3 id="sessionModalLabel">Create new game session</h3>
            </div>
            <div class="modal-body">
                <input id="sessionName" type="text" data-bind="value: sessionName" class="input-small homeBackground" placeholder="Session name"/>
                <input id="sessionLocation" type="text" data-bind="value: sessionLocation" class="input-small awayBackground" placeholder="Session location"/>
            </div>
            <div class="modal-footer">
                <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
                <button class="btn btn-primary" data-bind="click: $root.registerGameSession">Register</button>
            </div>
        </div>
    </div>
</div>


<script src="js/jquery-latest.js"></script>
<script src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/knockout-bootstrap.min.js"></script>

<script type="text/javascript">


    function MatchViewModel() {
        var self = this;
        self.setup = ko.observable(new MatchSetup());
        self.matches = ko.observableArray([]);
        self.awayGoals = ko.observable();
        self.homeGoals = ko.observable();

        self.activeSession = null;
        self.sessionName = ko.observable();
        self.sessionLocation = ko.observable();

        self.setupComplete = self.setup().isComplete

        self.showScoreModal = function () {
            $('#awayGoals').attr('placeholder', self.setup().awayPlayer() + " score");
            $('#homeGoals').attr('placeholder', self.setup().homePlayer() + " score");
            $('#resultModal').modal({
                keyboard: true
            })
        }

        self.registerScore = function () {

            var match = new Match();
            match.awayGoals = self.awayGoals();
            match.homeGoals = self.homeGoals();
            match.setup(ko.toJS(self.setup))
            self.matches.push(match);
            self.awayGoals('');
            self.homeGoals('');
            $('#resultModal').modal('hide');
        }

        self.showGameSessionModal = function() {
            $('#sessionModal').modal({
                keyboard: true
            })
        }

        self.registerGameSession = function() {
            var gameSession = new GameSession();
            gameSession.location = self.sessionLocation;
            gameSession.name = self.sessionName;
            $.ajax({
                url: "ajax/session",
                contentType: 'application/json',
                method: "POST",
                data: ko.toJSON(gameSession),
                success: function(data) {
                    console.log(data);
                    console.log(data.id);
                    var newSession = new GameSession();
                    newSession.id(data.id);
                    newSession.name(data.name);
                    newSession.location(data.location);
                    newSession.sessionStarted(data.sesssionStarted);
                    self.activeSession = newSession;


                }

            });
            $('#sessionModal').modal('hide');
        }

        self.availablePlayers = ko.observableArray([]);
        self.availableTeams = ko.observableArray([]);
    }


    var model;
    $(document).ready(function () {
        model = new MatchViewModel();
        ko.applyBindings(model);


        $.ajax({
                    url: "ajax/player",
                    async: true,
                    success: function (playerData, status) {
                        $.each(playerData, function (i, player) {
                            model.availablePlayers.push(player.userName);
                        });
                    }

                }
        );
        $.ajax({
            url: "ajax/team",
            async: true,
            success: function (teamData, status) {
                $.each(teamData, function (i, team) {
                    model.availableTeams.push(team.name);
                });
            }

        });

    });
</script>
</body>
</html>

